# QoderTypeAnalyzer 功能说明文档

## 概述

QoderTypeAnalyzer 是 ScriptDocGen 中 TypeAnalyzer 的增强版本，一个强大的 C# 类型分析工具，通过反射技术提供精确的类型成员信息分析。该模块包含 TypeAnalyzer 的所有功能，并在此基础上增加了更多高级特性，专注于解决接口实现与方法重写的准确识别、特殊方法的标识与格式化、以及类型成员的完整分析等核心问题。

## 核心功能特性

### 1. 类型成员分析

- **字段分析**：获取字段的访问修饰符、类型、是否静态等信息
- **属性分析**：分析属性的 getter/setter、访问控制、索引属性等
- **方法分析**：完整的方法签名、参数、返回值、修饰符分析
- **事件分析**：事件的委托类型、访问修饰符等信息
- **构造函数分析**：支持构造函数的完整分析
- **类型级分析**：类型种类、程序集、完整声明字符串等

### 2. 接口实现准确识别

- **核心问题解决**：正确区分接口实现与虚方法重写
- **显式接口实现**：识别显式接口实现方法
- **隐式接口实现**：识别隐式接口实现方法
- **关键字正确性**：确保接口实现方法不错误显示 `override` 关键字

### 3. 特殊方法标识与处理

- **运算符方法**：自动识别并正确格式化运算符重载方法
- **类型转换方法**：支持隐式/显式转换运算符的格式化
- **扩展方法**：识别扩展方法并提供标识
- **特殊标识**：提供三种互斥的特殊方法标识
  - `[Operator]` - 运算符重载方法
  - `[Conversion]` - 类型转换方法
  - `[Extension]` - 扩展方法

### 4. 多格式输出支持

- **源码一致格式**：与原始源代码声明完全一致的字符串
- **UML 格式**：符合 UML 标准的类图表示
- **详细分析格式**：包含分析标识的详细信息
- **可读格式**：便于人类阅读的友好格式

## 对外接口

### 主要工厂类
```csharp
// 创建类型数据，使用示例：TypeDataFactory.CreateTypeData(typeof(MyClass))
TypeData TypeDataFactory.CreateTypeData(Type type)
```

### 核心数据模型

#### TypeData - 类型数据

```csharp
// 基本信息
string Name                    // 类型名称，形如 "MyClass" 的内容
string Namespace              // 命名空间，形如 "MyProject.Models" 的内容
string FullName               // 完整类型名，形如 "MyProject.Models.MyClass" 的内容
AccessModifierType AccessModifier // 访问修饰符

// ScriptDocGen TypeAnalyzer 兼容属性
TypeCategory TypeCategory     // 类型种类，如 Class、Struct、Interface、Enum、Delegate、Record
string AssemblyName           // 程序集名称，形如 "MyProject.dll" 的内容
string TypeDeclaration        // 完整类型声明，形如：
                              // "[Serializable]\npublic class MyClass : BaseClass,\n    IMyInterface"

// 成员集合
FieldData[] AllFields         // 所有字段
PropertyData[] AllProperties  // 所有属性
MethodData[] AllMethods       // 所有方法
EventData[] AllEvents         // 所有事件

// 继承关系
Type[] InheritanceChain       // 继承链（基类类型数组）
Type[] ImplementedInterfaces  // 实现的接口类型数组

// 输出方法
string ToUMLClassDiagram()    // UML 类图，形如 "class MyClass { +field : int }" 的内容
string ToFormattedString()    // 格式化字符串，形如 "public class MyClass" 的内容
```

#### MethodData - 方法数据

```csharp
// 基本信息
string Name                   // 方法名称，形如 "GetUserInfo" 的内容
Type ReturnType              // 返回类型
ParameterData[] Parameters   // 方法参数

// 方法特性
bool IsStatic                // 是否静态
bool IsVirtual               // 是否虚方法
bool IsOverride              // 是否重写
bool IsAbstract              // 是否抽象
bool IsGeneric               // 是否泛型

// 特殊方法识别
bool IsExtensionMethod       // 是否扩展方法
bool IsSpecialName           // 是否特殊名称方法
bool IsInterfaceImplementation // 是否接口实现
string SpecialTag            // 特殊方法标识，形如 "[Operator]" 或 "[Extension]" 的内容

// 输出方法
string ToFormattedString()   // 与源码一致的声明，形如 "public void GetUserInfo(string name)" 的内容
string ToUMLString()         // UML 格式，形如 "+GetUserInfo(name: string): void" 的内容
string ToDetailedString()    // 包含分析信息的详细格式，形如 "public void GetUserInfo(string name) [Normal]" 的内容
```

#### FieldData - 字段数据

```csharp
// 基本信息
string Name                  // 字段名称，形如 "userName" 或 "_privateField" 的内容
Type FieldType              // 字段类型
bool IsStatic               // 是否静态
bool IsReadOnly             // 是否只读
bool IsConstant             // 是否常量

// 输出方法
string ToFormattedString()  // 格式化声明，形如 "public string userName" 的内容
string ToUMLString()        // UML 格式，形如 "+userName : string" 的内容
```

#### PropertyData - 属性数据
```csharp

// 基本信息
string Name                 // 属性名称，形如 "UserName" 或 "Item" 的内容
Type PropertyType          // 属性类型
bool HasGetter             // 是否有 getter
bool HasSetter             // 是否有 setter
bool IsIndexer             // 是否索引属性

// 输出方法
string ToFormattedString() // 格式化声明，形如 "public string UserName { get; set; }" 的内容
string ToUMLString()       // UML 格式，形如 "+UserName : string" 的内容
```

#### EventData - 事件数据
```csharp
// 基本信息
string Name                // 事件名称，形如 "OnValueChanged" 或 "DataUpdated" 的内容
Type EventHandlerType     // 事件处理器类型
bool IsStatic             // 是否静态

// 输出方法
string ToFormattedString() // 格式化声明，形如 "public event Action<string> OnValueChanged" 的内容
string ToUMLString()       // UML 格式，形如 "+OnValueChanged : Action<string>" 的内容
```

### 辅助检测类
```csharp
// 成员生成检测
bool MemberGenerationDetector.IsAutoGeneratedMethod(MethodInfo)
bool MemberGenerationDetector.IsOperatorMethod(MethodInfo)
bool MemberGenerationDetector.IsConversionMethod(MethodInfo)

// 特性过滤（支持自定义过滤器）
bool IAttributeFilter.ShouldInclude(Type attributeType)
AttributeFilters.SetCurrentFilter(IAttributeFilter filter) // 设置当前过滤器
AttributeFilters.ResetToDefault()                           // 重置为默认过滤器

// 类型分析扩展（与 ScriptDocGen 兼容）
TypeCategory Type.GetTypeCategory()                        // 获取类型种类
string Type.GetTypeDeclaration()                           // 获取完整声明字符串
string Type.GetReadableTypeName(bool useFullName = false)  // 获取可读类型名
```

## 核心解决的问题

### 1. 接口实现误判问题
**问题**：接口实现方法被错误标记为 `override`
**解决**：通过 `IsInterfaceImplementation` 属性准确识别接口实现，确保声明字符串的正确性

### 2. 特殊方法格式化问题
**问题**：运算符和转换方法的声明格式与源码不一致
**解决**：特殊处理运算符方法和转换方法的声明格式，确保与源码完全一致

### 3. 特殊方法标识需求
**问题**：无法直接获取方法的特殊类型标识
**解决**：提供 `SpecialTag` 属性，支持三种互斥标识的自动判定

### 4. 自动生成成员过滤
**问题**：编译器生成的成员影响分析结果
**解决**：提供智能过滤机制，保留用户定义的特殊方法

## 使用场景

- **API 文档生成**：自动生成准确的 API 文档
- **代码分析工具**：构建代码结构分析器
- **UML 图生成**：生成标准的 UML 类图
- **开发者工具**：IDE 插件、代码浏览器等
- **反射信息展示**：运行时类型信息查看器

### 使用示例
```csharp
// 分析一个类型
var typeData = TypeDataFactory.CreateTypeData(typeof(MyClass));

// 获取基本信息
Console.WriteLine($"类型名：{typeData.Name}");           // 输出："MyClass"
Console.WriteLine($"命名空间：{typeData.Namespace}");     // 输出："MyProject.Models"

// ScriptDocGen TypeAnalyzer 兼容功能
Console.WriteLine($"类型种类：{typeData.TypeCategory}");   // 输出：Class
Console.WriteLine($"程序集：{typeData.AssemblyName}");     // 输出："MyProject.dll"
Console.WriteLine($"完整声明：\n{typeData.TypeDeclaration}");
// 输出类似：
// [Serializable]
// public class MyClass : BaseClass,
//     IMyInterface

// 分析方法
foreach (var method in typeData.AllMethods)
{
    Console.WriteLine($"方法：{method.ToFormattedString()}");  // 输出："public void GetData()"
    if (method.SpecialTag != null)
        Console.WriteLine($"特殊标识：{method.SpecialTag}");    // 输出："[Operator]"
}

// 生成 UML 类图
string umlDiagram = typeData.ToUMLClassDiagram();
// 输出类似："class MyClass { +GetData(): void }"

// 特性过滤示例
var customFilter = new CustomAttributeFilter();
AttributeFilters.SetCurrentFilter(customFilter);
// 重新创建 TypeData 时将使用自定义过滤器
```

## 技术特点

- **高精度分析**：通过反射技术提供准确的类型信息
- **格式化保真**：确保输出与源码声明完全一致
- **扩展性设计**：模块化架构，易于功能扩展
- **性能优化**：高效的数据缓存和处理机制
- **标准兼容**：输出格式符合相关标准（UML、C# 语法等）

## 注意事项

1. **格式化原则**：`ToFormattedString()` 方法保证与源码完全一致，不添加任何分析标识
2. **特殊标识互斥**：`SpecialTag` 中的 `[Operator]`、`[Conversion]`、`[Extension]` 三种标识互斥
3. **优先级规则**：特殊标识按运算符 > 转换 > 扩展的优先级进行判定
4. **接口实现识别**：正确区分接口实现与虚方法重写，避免错误的 `override` 标记

---

*此文档遵循最小知识原则，专注于功能接口说明，不涉及具体实现细节。*